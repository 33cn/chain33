package eth

import (
	"context"
	"encoding/json"
	"errors"
	"fmt"
	clientMocks "github.com/33cn/chain33/client/mocks"
	"github.com/33cn/chain33/queue"
	etypes "github.com/33cn/chain33/rpc/ethrpc/types"
	"github.com/33cn/chain33/system/dapp/coins/types"
	ctypes "github.com/33cn/chain33/types"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/common/math"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/ethereum/go-ethereum/rlp"
	"math/rand"

	ethtypes "github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/signer/core/apitypes"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
	"github.com/stretchr/testify/require"
	"math/big"
	"strings"
	"testing"
	"time"

	chain33crypto "github.com/33cn/chain33/common/crypto"
	"github.com/ethereum/go-ethereum/accounts/abi"
)

var (
	ethCli *ethHandler
	qapi   *clientMocks.QueueProtocolAPI

	q = queue.New("test")
)

func init() {
	qapi = &clientMocks.QueueProtocolAPI{}
	cfg := ctypes.NewChain33Config(ctypes.GetDefaultCfgstring())
	q.SetConfig(cfg)

	ethCli = &ethHandler{}
	ethCli.evmChainID = 3999
	ethCli.cfg = cfg
	ethCli.cli.Init(q.Client(), qapi)

}

func TestEthHandler_Accounts(t *testing.T) {
	var account = &ctypes.WalletAccount{Acc: &ctypes.Account{Addr: "0xa42431Da868c58877a627CC71Dc95F01bf40c196"}, Label: "test1"}
	var account2 = &ctypes.WalletAccount{Acc: &ctypes.Account{Addr: "0xBe807Dddb074639cD9fA61b47676c064fc50D62C"}, Label: "test2"}
	var resp = &ctypes.WalletAccounts{
		Wallets: []*ctypes.WalletAccount{account, account2},
	}
	req := &ctypes.ReqAccountList{WithoutBalance: true}
	qapi.On("ExecWalletFunc", "wallet", "WalletGetAccountList", req).Return(nil, errors.New("wrong param"))
	accs, err := ethCli.Accounts()
	assert.NotNil(t, err)
	assert.Equal(t, 0, len(accs))
	qapi = &clientMocks.QueueProtocolAPI{}
	qapi.On("ExecWalletFunc", "wallet", "WalletGetAccountList", req).Return(resp, nil)
	var addrs = []string{"0xa42431Da868c58877a627CC71Dc95F01bf40c196", "0xBe807Dddb074639cD9fA61b47676c064fc50D62C"}
	ethCli.cli.Init(q.Client(), qapi)
	accs, err = ethCli.Accounts()
	assert.Nil(t, err)
	assert.Equal(t, accs, addrs)
}

func TestEthHandler_BlockNumber(t *testing.T) {
	var header ctypes.Header
	header.Height = 102400
	qapi.On("GetLastHeader", mock.Anything).Return(&header, nil)
	bnum, err := ethCli.BlockNumber()
	assert.Nil(t, err)
	t.Log("blocknum:", bnum)
	bn := big.NewInt(header.Height)
	assert.Equal(t, hexutil.EncodeBig(bn), bnum.String())
}

func TestEthHandler_Mining(t *testing.T) {
	var status = new(ctypes.WalletStatus)
	status.IsAutoMining = true
	qapi.On("ExecWalletFunc", "wallet", "GetWalletStatus", &ctypes.ReqNil{}).Return(status, nil)
	mining, err := ethCli.Mining()
	assert.Nil(t, err)
	t.Log("mining:", mining)
	assert.Equal(t, true, mining)
}

func TestEthHandler_GetBalance(t *testing.T) {
	var req ctypes.ReqBalance
	req.Execer = "coins"
	req.AssetSymbol = "bty"
	addr := "0x1E79307966B830bCdfEAB1Ed09871d248c2fE171"
	req.Addresses = []string{addr}

	var header ctypes.Header
	header.Height = 102400
	head := &ctypes.Header{StateHash: []byte("sdfadasds")}
	qapi.On("GetLastHeader").Return(head, nil)
	qapi.On("GetConfig").Return(ethCli.cfg, nil)
	var acc = &ctypes.Account{Addr: "0x1E79307966B830bCdfEAB1Ed09871d248c2fE171", Balance: 5e8}
	accv := ctypes.Encode(acc)
	storevalue := &ctypes.StoreReplyValue{}
	storevalue.Values = append(storevalue.Values, accv)
	qapi.On("StoreGet", mock.Anything).Return(storevalue, nil)
	var tag = "latest"
	balanceHexStr, err := ethCli.GetBalance(addr, &tag)
	assert.Nil(t, err)
	t.Log("balance", balanceHexStr.String())
	assert.Equal(t, balanceHexStr.String(), "0x4563918244f40000")
}

func TestEthHandler_GetBlock(t *testing.T) {
	var resp ctypes.BlockDetails
	var item ctypes.BlockDetail

	resp.Items = append(resp.GetItems(), &item)

	transfer := &ctypes.AssetsTransfer{
		Cointoken: "",
		Amount:    102454299999,
		To:        "",
		Note:      nil,
	}

	v := &types.CoinsAction_Transfer{Transfer: transfer}
	action := &types.CoinsAction{Value: v, Ty: types.CoinsActionTransfer}
	item.Block = &ctypes.Block{
		Height:     70,
		BlockTime:  1648792721,
		Version:    0,
		ParentHash: common.FromHex("25bfcebbeedd16039bb22f0e15702f9e7a0f6d8a3ae05e2e7e6fd7ce66babb36"),
		TxHash:     common.FromHex("0xfe4a45a5b946e7de1d6c0bcd3f47d0d4b68bb252009bd032f9102854346c3217"),
		Txs: []*ctypes.Transaction{{
			Execer:  []byte("coins"),
			Payload: ctypes.Encode(action),
			Expire:  0,
			Nonce:   2871810575193867206,
			ChainID: 88,
			To:      "0xde79a84dd3a16bb91044167075de17a1ca4b1d6b",
			Signature: &ctypes.Signature{
				Ty:        1,
				Pubkey:    common.FromHex("0x02f5263862dae4e8516e08e5551f353be05f479c4d36ea754a7b2b359f81fbebb1"),
				Signature: common.FromHex("0x30450221008259d987850c34036a33ede7db25ea72dbe92edd3e9bfe6cbcabd0c43c427a9902206f410d921d6b0d09ce9a8cdf0db9f8eec64677c56404fcd2ccf0e2c5ef4dd06a"),
			},
		}},
		Difficulty: 520159231,
		MainHash:   common.FromHex("0x660f78e492bf2630ecd4d8fdf09ec64f0e141bdfeb7636ed4992b31dd81338bd"),
		MainHeight: 70,
	}

	testEthAPIGetBlockByHash(t, &resp)
	testEthAPIGetBlockByNumber(t, &resp)

}
func testEthAPIGetBlockByHash(t *testing.T, resp *ctypes.BlockDetails) {
	var hash = "0x660f78e492bf2630ecd4d8fdf09ec64f0e141bdfeb7636ed4992b31dd81338bd"
	var req ctypes.ReqHashes
	req.Hashes = append(req.Hashes, common.FromHex(hash))
	qapi.On("GetBlockByHashes", &req).Return(resp, nil)
	block, err := ethCli.GetBlockByHash(common.HexToHash(hash), true)
	assert.Nil(t, err)
	assert.Equal(t, block.Header.Number.String(), "0x46")

}

func testEthAPIGetBlockByNumber(t *testing.T, resp *ctypes.BlockDetails) {
	var req ctypes.ReqBlocks
	req.Start = 70
	req.End = 70
	req.IsDetail = true
	qapi.On("GetBlocks", &req).Return(resp, nil)
	num := (*hexutil.Big)(big.NewInt(req.Start))
	block, err := ethCli.GetBlockByNumber(num.String(), true)
	assert.Nil(t, err)
	assert.Equal(t, num.String(), block.Header.Number.String())
}

func TestEthHandler_ChainId(t *testing.T) {
	ethCli.evmChainID = 0x21
	id, err := ethCli.ChainId()
	assert.Nil(t, err)
	assert.Equal(t, id.String(), "0x21")
}

func TestEthHandler_EstimateGas(t *testing.T) {

	qapi.On("Query", mock.Anything).Return("0x12345", nil)
	var msg etypes.CallMsg
	msg.From = "1N2aNfWXqGe9kWcL8u9TYpj5RzVQbjwKAP"
	msg.To = "1QHKXSGAgmCyZXhmkjPR4eRy7vHeezeiD6"
	msg.Value = (*hexutil.Big)(big.NewInt(1))
	_, err := ethCli.EstimateGas(&msg)
	assert.NotNil(t, err)
}

func TestEthHandler_GetTransactionCount(t *testing.T) {
	qapi.On("Query", mock.Anything).Return("0x12", nil)
	addr := "0xd83b69c56834e85e023b1738e69bfa2f0dd52905"
	_, err := ethCli.GetTransactionCount(addr, "latest")
	assert.NotNil(t, err)

}

func TestEthHandler_GetTxCount(t *testing.T) {
	blockdetails := &ctypes.BlockDetails{Items: []*ctypes.BlockDetail{
		{
			Block: &ctypes.Block{
				Txs: []*ctypes.Transaction{
					{},
				},
			},
		},
	}}

	qapi.On("GetBlockByHashes", mock.Anything).Return(blockdetails, nil)
	var hash = "0x660f78e492bf2630ecd4d8fdf09ec64f0e141bdfeb7636ed4992b31dd81338bd"
	count, err := ethCli.GetBlockTransactionCountByHash(common.HexToHash(hash))
	assert.Nil(t, err)
	assert.Equal(t, 1, int(count))

	qapi.On("GetBlocks", mock.Anything).Return(blockdetails, nil)
	count, err = ethCli.GetBlockTransactionCountByNumber((*hexutil.Big)(big.NewInt(70)))
	assert.Nil(t, err)
	assert.Equal(t, 1, int(count))
}

func TestEthHandler_GetTransaction(t *testing.T) {
	hexTxs := "0ab60b0ab9050a13757365722e702e7061726164656d6f2e65766d12d70310c09a0c18012a44a9059cbb000000000000000000000000c05109180ac5298e3a9b7d7e70abf98ffb986d22000000000000000000000000000000000000000000000000000000002114a0c03adc02663861633461383530323534306265343030383330333064343039343061326238643935636539346166623439633534373431623031313735363932363139613865373338306238343461393035396362623030303030303030303030303030303030303030303030306330353130393138306163353239386533613962376437653730616266393866666239383664323230303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303231313461306330383231663632613034663962383065356635316436353436663533663161343636396432326237383933353638656335373063336137366235356434366162336566346663323961613032393230353439373334356437613562623566666236656332636163306338633139323035306430313637363066613533303762313535363235646330373235422a3078306132623844393563453934416642343943353437343142303131373536393236313941386537331a8901088442124104e822f01d1422502b6a19ebfa1ac94a87d7e6b13be232e3ff451e5ba05d59bb247855104cb0dc788d48e0e991027c9815ccb21f8e70277873606238a233bb9f1e1a414f9b80e5f51d6546f53f1a4669d22b7893568ec570c3a76b55d46ab3ef4fc29a29205497345d7a5bb5ffb6ec2cac0c8c192050d016760fa5307b155625dc07250120c09a0c30bdedf58fc6849ea382013a2a307864343231353138393136353734326266363538356431613566376133353935356164303036633933589f1f12af0508021ac80108dc0412c2010a7c4c4f44422d65766d2d73746174653a3078306132623864393563653934616662343963353437343162303131373536393236313961386537333a3078663766663730313765313030373030396563343730316333643638316663396239383164363936376262343666353038313230343032393236633635303361371220000000000000000000000000000000000000000000000000000000e86f511f001a20000000000000000000000000000000000000000000000000000000e84e3c7e401ac80108dc0412c2010a7c4c4f44422d65766d2d73746174653a3078306132623864393563653934616662343963353437343162303131373536393236313961386537333a307865366136613439313938663433383636663332646562656130313463303265313262376130616639353530623031373136663034643436393332643730303463122000000000000000000000000000000000000000000000000000000000000000001a20000000000000000000000000000000000000000000000000000000002114a0c01a8e0108dd041288010a20ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef0a20000000000000000000000000d83b69c56834e85e023b1738e69bfa2f0dd529050a20000000000000000000000000c05109180ac5298e3a9b7d7e70abf98ffb986d221220000000000000000000000000000000000000000000000000000000002114a0c01a830108db04127e0a2a3078643833623639633536383334653835653032336231373338653639626661326630646435323930351a2a30783061326238643935636539346166623439633534373431623031313735363932363139613865373320b0dc012a200000000000000000000000000000000000000000000000000000000000000001209e02280130bddac59506422a3078643833623639633536383334653835653032336231373338653639626661326630646435323930354a0f63616c6c45766d436f6e7472616374"
	var details ctypes.TransactionDetails
	err := ctypes.Decode(common.FromHex(hexTxs), &details)
	if err != nil {
		t.Log(err)
		return
	}
	detail := details.GetTxs()[0]
	qapi.On("QueryTx", mock.Anything).Return(detail, nil)
	qapi.On("GetBlockHash", mock.Anything).Return(&ctypes.ReplyHash{Hash: common.FromHex("0xea482c18fa9c7665e826fa4a1f3d1e77250fde41535e2b66e43baaa320763206")}, nil)
	hexhash := "0xdd99c27b9d5892d485962fb33befad420f655ef75da1a8ca4f8f9873ab10de34"
	txs, err := ethCli.GetTransactionByHash(common.HexToHash(hexhash))
	assert.Nil(t, err)
	assert.Equal(t, txs.Hash.String(), hexhash)
	assert.Equal(t, txs.BlockHash.String(), "0xea482c18fa9c7665e826fa4a1f3d1e77250fde41535e2b66e43baaa320763206")
	_, err = ethCli.GetTransactionReceipt(common.HexToHash(hexhash))
	assert.Nil(t, err)

}

func TestEthHandler_GetCode(t *testing.T) {
	var ret struct {
		Creator  string         ` json:"creator,omitempty"`
		Name     string         ` json:"name,omitempty"`
		Alias    string         ` json:"alias,omitempty"`
		Addr     string         ` json:"addr,omitempty"`
		Code     *hexutil.Bytes ` json:"code,omitempty"`
		CodeHash []byte         ` json:"codeHash,omitempty"`
		// 绑定ABI数据 ForkEVMABI
		Abi string `json:"abi,omitempty"`
	}
	code := common.FromHex("0x6080604052600436106100555760003560e01c8063481c6a751461005a5780635d495aea146100855780635ec01e4d1461009c578063e97dcb62146100c7578063efa1c482146100d1578063f71d96cb146100fc575b600080fd5b34801561006657600080fd5b5061006f610139565b60405161007c91906107d0565b60405180910390f35b34801561009157600080fd5b5061009a61015d565b005b3480156100a857600080fd5b506100b161033b565b6040516100be919061084d565b60405180910390f35b6100cf610371565b005b3480156100dd57600080fd5b506100e661041f565b6040516100f391906107eb565b60405180910390f35b34801561010857600080fd5b50610123600480360381019061011e91906105a8565b6104ad565b60405161013091906107d0565b60405180910390f35b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101eb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101e29061082d565b60405180910390fd5b60006001805490506101fb61033b565b610205919061096a565b905060018181548110610241577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156102b1573d6000803e3d6000fd5b50600067ffffffffffffffff8111156102f3577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156103215781602001602082028036833780820191505090505b50600190805190602001906103379291906104ec565b5050565b60004442600160405160200161035393929190610797565b6040516020818303038152906040528051906020012060001c905090565b662386f26fc1000034116103ba576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103b19061080d565b60405180910390fd5b6001339080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b606060018054806020026020016040519081016040528092919081815260200182805480156104a357602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610459575b5050505050905090565b600181815481106104bd57600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b828054828255906000526020600020908101928215610565579160200282015b828111156105645782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061050c565b5b5090506105729190610576565b5090565b5b8082111561058f576000816000905550600101610577565b5090565b6000813590506105a2816109ea565b92915050565b6000602082840312156105ba57600080fd5b60006105c884828501610593565b91505092915050565b60006105dd8383610601565b60208301905092915050565b60006105f5838361061f565b60208301905092915050565b61060a8161090a565b82525050565b6106198161090a565b82525050565b6106288161090a565b82525050565b60006106398261088d565b61064381856108bd565b935061064e83610868565b8060005b8381101561067f57815161066688826105d1565b9750610671836108a3565b925050600181019050610652565b5085935050505092915050565b600061069782610898565b6106a181856108ce565b93506106ac83610878565b8060005b838110156106e4576106c1826109ca565b6106cb88826105e9565b97506106d6836108b0565b9250506001810190506106b0565b5085935050505092915050565b60006106fe601a836108d9565b91507f746865206d696e20616d6f756e7420697320302e3031206574680000000000006000830152602082019050919050565b600061073e601b836108d9565b91507f796f7520617265206e6f7420616c6c6f77656420746f207069636b00000000006000830152602082019050919050565b61077a8161093c565b82525050565b61079161078c8261093c565b610960565b82525050565b60006107a38286610780565b6020820191506107b38285610780565b6020820191506107c3828461068c565b9150819050949350505050565b60006020820190506107e56000830184610610565b92915050565b60006020820190508181036000830152610805818461062e565b905092915050565b60006020820190508181036000830152610826816106f1565b9050919050565b6000602082019050818103600083015261084681610731565b9050919050565b60006020820190506108626000830184610771565b92915050565b6000819050602082019050919050565b60008190508160005260206000209050919050565b600081519050919050565b600081549050919050565b6000602082019050919050565b6000600182019050919050565b600082825260208201905092915050565b600081905092915050565b600082825260208201905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006109158261091c565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000610959610954836109dd565b6108ea565b9050919050565b6000819050919050565b60006109758261093c565b91506109808361093c565b9250826109905761098f61099b565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60006109d68254610946565b9050919050565b60008160001c9050919050565b6109f38161093c565b81146109fe57600080fd5b5056fea26469706673582212200803e202ec4ea4add02f57a64f3b9931a5363412f1190e8221074375d2ad81d764736f6c63430008000033")
	ret.Code = (*hexutil.Bytes)(&code)
	qapi.On("Query", mock.Anything).Return(&ret, nil)
	caddr := "0xd01c479dee5e61c52ded7422a634220ba91e2447"
	addr := common.HexToAddress(caddr)

	_, err := ethCli.GetCode(&addr, "")
	assert.Equal(t, "ErrNotSupport", err.Error())
}

func Test_Eip712SignTypeData(t *testing.T) {
	deadline := big.NewInt(time.Now().Unix() + 3600)
	v := big.NewInt(1e8)
	n := big.NewInt(0)
	id := big.NewInt(22)
	t.Log("deadline:", deadline.Int64())
	var testTypedData = &apitypes.TypedData{
		Domain: apitypes.TypedDataDomain{
			Name:              "WLT",
			Version:           "1",
			ChainId:           (*math.HexOrDecimal256)(id),
			VerifyingContract: "0xde17a85756815bf5755173603f2b07e69455f654",
		},
		Message: apitypes.TypedDataMessage{
			"sender":    "0xd741c9f9e0A1F5bb1ed898115A683253F14c1F8b",
			"recipient": "0xDe79A84DD3A16BB91044167075dE17a1CA4b1d6b",
			"value":     (*math.HexOrDecimal256)(v),
			"nonce":     (*math.HexOrDecimal256)(n),
			"deadline":  (*math.HexOrDecimal256)(big.NewInt(1653046056)),
		},
		PrimaryType: "TransferFrom",
		Types: apitypes.Types{
			"EIP712Domain": {
				{
					Name: "name",
					Type: "string",
				},
				{
					Name: "version",
					Type: "string",
				},
				{
					Name: "chainId",
					Type: "uint256",
				},
				{
					Name: "verifyingContract",
					Type: "address",
				},
			},
			"TransferFrom": {
				{
					Name: "sender",
					Type: "address",
				},
				{
					Name: "recipient",
					Type: "address",
				},
				{
					Name: "value",
					Type: "uint256",
				},
				{
					Name: "nonce",
					Type: "uint256",
				},
				{
					Name: "deadline",
					Type: "uint256",
				},
			},
		},
	}

	jbs, _ := json.MarshalIndent(testTypedData, "", "\t")
	t.Log("jsonstr:", string(jbs))
	var privKey = "427da8655959736f02d0e4e557a6c343e5ccc20e8516c3980bf948b430d511fb"
	pk, err := crypto.ToECDSA(common.FromHex(privKey))
	if err != nil {
		t.Log(err)
		return
	}
	encodedData, err := testTypedData.EncodeData("EIP712Domain", testTypedData.Domain.Map(), 1)
	if err != nil {
		t.Log(err)
		return
	}

	t.Log("encodeData:", common.Bytes2Hex(encodedData))
	domainSeparator, err := testTypedData.HashStruct("EIP712Domain", testTypedData.Domain.Map())
	if err != nil {
		t.Log(err)
		return
	}

	t.Log("domain hash", domainSeparator.String())
	typedDataHash, err := testTypedData.HashStruct(testTypedData.PrimaryType, testTypedData.Message)
	if err != nil {
		t.Log(err)
		return
	}

	rawData := []byte(fmt.Sprintf("\x19\x01%s%s", string(domainSeparator), string(typedDataHash)))
	hash := crypto.Keccak256(rawData)
	sig, err := crypto.Sign(hash, pk)
	if err != nil {
		t.Log(err)
		return
	}

	t.Log("sigdata:", common.Bytes2Hex(sig))
	//通过哈希和签名数据恢复出公钥
	pub, err := crypto.Ecrecover(hash, sig)
	if err != nil {
		t.Log("err", err)
		return
	}
	t.Log("pub", common.Bytes2Hex(pub))
	assert.Equal(t, "046d21eac1b7a11fdeb7e0b759e0f479240a8a3630d191808c072792611408c4580e5f57b96d9f073eb00f9355c301f31bf274705da1a0f969434106ed26cd7570", common.Bytes2Hex(pub))
	epub, _ := crypto.UnmarshalPubkey(pub)
	addr := crypto.PubkeyToAddress(*epub).String()
	t.Log("addr:", addr)
	assert.Equal(t, "0xd741c9f9e0A1F5bb1ed898115A683253F14c1F8b", addr)
}

func TestSendSignTypeData(t *testing.T) {
	eabi, _ := abi.JSON(strings.NewReader(abidata))
	//parameter := fmt.Sprintf("transferFromWithSignature(%s, %s,%d,%d,%s)")
	/*
		transferFromWithSignature(
		        address sender,
		        address recipient,
		        uint256 amount,
		        uint256 deadline,
		        bytes memory signature
		    )
	*/
	var from = "0xd741c9f9e0A1F5bb1ed898115A683253F14c1F8b"
	var to = "0xDe79A84DD3A16BB91044167075dE17a1CA4b1d6b"
	var value = 1e8
	var sig = "d6266993b09c1ae68df69e417b431466778e595467c1dd40ae31bab6ea974f0e3485679b965d3f411077e443ba1b39fd098a5a8d4507aaa91af767106164a4b501"
	t.Log(len(common.FromHex(sig)))
	var sigdata [65]byte
	copy(sigdata[:], common.Hex2Bytes(sig)[:])
	//param:= fmt.Sprintf("transferFromWithSignature(%s, %d ,%d, %d ,%s)",from,to,value,time.Now().Unix()+3600,sig)
	var iargs []interface{}
	iargs = append(iargs, common.HexToAddress(from), common.HexToAddress(to), big.NewInt(int64(value)), big.NewInt(1654849059), sigdata[:])
	packdata, err := eabi.Pack("transferFromWithSignature", iargs...)
	assert.Nil(t, err)
	t.Log("packdata", common.Bytes2Hex(packdata))

}

var abidata = "[{\"inputs\":[{\"internalType\":\"string\",\"name\":\"name_\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"symbol_\",\"type\":\"string\"},{\"internalType\":\"uint256\",\"name\":\"supply\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"uint8\",\"name\":\"decimals_\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"chainid_\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"}],\"name\":\"Approval\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"bytes32\",\"name\":\"hashStruct\",\"type\":\"bytes32\"},{\"indexed\":true,\"internalType\":\"bytes32\",\"name\":\"hash\",\"type\":\"bytes32\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"signer\",\"type\":\"address\"}],\"name\":\"Log\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"}],\"name\":\"Transfer\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"DOMAIN_SEPARATOR\",\"outputs\":[{\"internalType\":\"bytes32\",\"name\":\"\",\"type\":\"bytes32\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"PERMIT_TYPEHASH\",\"outputs\":[{\"internalType\":\"bytes32\",\"name\":\"\",\"type\":\"bytes32\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"TRANSFERFROM_TYPEHASH\",\"outputs\":[{\"internalType\":\"bytes32\",\"name\":\"\",\"type\":\"bytes32\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"}],\"name\":\"allowance\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"approve\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"balanceOf\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"decimals\",\"outputs\":[{\"internalType\":\"uint8\",\"name\":\"\",\"type\":\"uint8\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"subtractedValue\",\"type\":\"uint256\"}],\"name\":\"decreaseAllowance\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"addedValue\",\"type\":\"uint256\"}],\"name\":\"increaseAllowance\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"name\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"nonces\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"deadline\",\"type\":\"uint256\"},{\"internalType\":\"bytes\",\"name\":\"signature\",\"type\":\"bytes\"}],\"name\":\"permit\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"symbol\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"totalSupply\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"transfer\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"sender\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"transferFrom\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"sender\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"deadline\",\"type\":\"uint256\"},{\"internalType\":\"bytes\",\"name\":\"signature\",\"type\":\"bytes\"}],\"name\":\"transferFromWithSignature\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]"

func TestEthHandler_SendRawTransaction(t *testing.T) {

	metamaskRawTx := "0xf8ac438502540be40083030d4094a7672ff66dfed1c506efd53638eff627e92639aa80b844a9059cbb000000000000000000000000643c5addddbf2734b8896aa74c38ffab6723cbf1000000000000000000000000000000000000000000000000000000001dcd6500821f61a09cfbbbe0ae7b4a5f698704fe900cf03fc58d01ee4dab7be142dc58a954d2f0e8a07efe0285dc17bfdb5a3c60b7cd8b54ea8fc280d7d9d1864975d6567519cf63d9"
	sigstr := "9cfbbbe0ae7b4a5f698704fe900cf03fc58d01ee4dab7be142dc58a954d2f0e87efe0285dc17bfdb5a3c60b7cd8b54ea8fc280d7d9d1864975d6567519cf63d900"
	pubkeystr := "04e822f01d1422502b6a19ebfa1ac94a87d7e6b13be232e3ff451e5ba05d59bb247855104cb0dc788d48e0e991027c9815ccb21f8e70277873606238a233bb9f1e"
	contractAddr := "0xa7672fF66DfeD1c506efd53638efF627E92639AA"

	rawData := common.FromHex(metamaskRawTx)
	require.NotNil(t, rawData)
	ntx := new(ethtypes.Transaction)
	err := ntx.UnmarshalBinary(rawData)
	require.Nil(t, err)
	require.Equal(t, ntx.To().String(), contractAddr)
	signer := ethtypes.NewLondonSigner(ntx.ChainId())
	txSha3 := signer.Hash(ntx)
	_, r, s := ntx.RawSignatureValues()
	sig := append(r.Bytes()[:], append(s.Bytes()[:], uint8(0))...)
	require.Equal(t, common.Bytes2Hex(sig), sigstr)
	pubkey, _ := crypto.Ecrecover(txSha3.Bytes(), sig)
	require.NotNil(t, pubkey)
	require.Equal(t, common.Bytes2Hex(pubkey), pubkeystr)

	chain33Tx := etypes.AssembleChain33Tx(ntx, sig, pubkey, ethCli.cfg)
	t.Log("checkchainID", ntx.ChainId(), "support chainid", ethCli.evmChainID)
	chain33crypto.Init(ethCli.cfg.GetModuleConfig().Crypto, ethCli.cfg.GetSubConfig().Crypto)
	ok := chain33Tx.CheckSign(-1)
	require.True(t, ok)

	//测试修改chain33Tx 数据，期望验签失败
	//修改Nonce
	chain33Tx.Nonce = rand.New(rand.NewSource(time.Now().UnixNano())).Int63()
	ok = chain33Tx.CheckSign(-1)
	require.False(t, ok)
	//修改to
	chain33Tx.To = "0xa06c8907eb1c8a266165f5484c5ea3bd4e0520a8"
	ok = chain33Tx.CheckSign(-1)
	require.False(t, ok)
	//修改执行器
	chain33Tx.Execer = []byte("coinsX")
	ok = chain33Tx.CheckSign(-1)
	require.False(t, ok)
	//修改packdata
	chain33Tx.Payload = append(chain33Tx.GetPayload(), uint8(8))
	ok = chain33Tx.CheckSign(-1)
	require.False(t, ok)
	//修改chainID
	chain33Tx.ChainID = 666
	ok = chain33Tx.CheckSign(-1)
	require.False(t, ok)
	qapi.On("Query", mock.Anything).Return("0x12", nil)
	qapi.On("SendTx", mock.Anything).Return(&ctypes.Reply{Msg: common.FromHex("56385265533f4c17455473508f4bfcfcfd094a88f460de40f22dd4c19e485793"), IsOk: true}, nil)

	_, err = ethCli.SendRawTransaction(metamaskRawTx)
	assert.NotNil(t, err)
}

func TestEthHandler_ProxyExecTx(t *testing.T) {
	var nonce uint64 = 40
	var to = common.HexToAddress("0x0000000000000000000000000000000000200005")

	//绑定接口获取的构造的交易数据
	var bindRawTx = "0a067469636b6574125c50112a580a2a307836366165656133393233316434383730313536396466386235396266356564616638313934653430122a30786134323433316461383638633538383737613632376363373164633935663031626634306331393620a08d06309cdecd89eef5b2bb123a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470"
	//var unbindRawTx = "0a067469636b657412b525500d1ab0250acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078656234623539323566366435373261376439633837363166306236323963663865313838643566643332313839623861353264396231376261373430386135633a303030303030303030303a363465326661653165643537316166613461396561343662646161663161326334343065376439663631313963303535363861623339313337376539653065353a313639333031323835383237383335343938380acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078656163643737653232663139303263396338653763323665383561613462623166323632353038363734643662623266386137343337643265396464383665363a303030303030303030303a306139373966396633353761393332613766393431636632656465633331396239323864396239323730616563653237396566303532663730356135616331643a313639333133323134363238333533373133380acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078653564626233653730613964346539636130663234396136636338643062333234613365396261613539386437316361353632353732383137646265386232373a303030303030303030303a333634623332376265323362303965666561383335393761346161373131383232623962363763616238353562353231313761396436646637346539613033653a313639333130303832383238383530343636350acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078643834656231633435343463346564626433616235643034373330313339336433646535626363313135626333396633643265356531646638376236373538363a303030303030303030303a353530656435653831323130613833343264653661323235633463363066383635303533623236653633306135353038373538376462616266623630393664333a313639333031383632393238373838303135350acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078643830613664316331373236323763636136643961623930326636356563343466363931643935326332356630363561376166313061616230666333663938663a303030303030303030313a356234353962343635346638383661663363353234356665336135303661346265363237663164333762356137396662646138616331363231353765363733363a313639333030303939363239373735303135390acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078643531356561323330313462636264303235653339316663643732326232386538373766343763633865643730383830383934326439353432353934343136363a303030303030303030303a383138613465666438313432303364363063376432613830356633633930366463323437373766663765366536383961613730326637356365613764346565613a313639333032373235373237373937343333300acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078633430396639653034316131396662393662376263643830303765643237376234626135383461306635363936343166653031663831383864303032323431613a303030303030303030303a623538366532623436386637656530366564356130383664643263363731326165373836306634376235363931623032666631623637343864353334613735333a313639333033303633333239313437383934360acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078626530343637373933393237633933313865333264313235623036653937306161653963646336353334323634653163613536343731633761346335353261663a303030303030303031353a366363353161376633333935616439623136666162326365306238633833363864613964623164386539663066333130303664346535306462643864653338353a313639323934363032323238353538343532340acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078623937346435663330373030333233303966333932393665666131623634626435623163353735386530666536313333613562646662383539333666373238643a303030303030303030303a666339643335623135363761663461346666323832376438343266663138336636663062616339343237363733633836396534643436303563323636313432373a313639333131393232303332333331303334320acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078393339316466633035393435393461613534366434623732616532313662633634613438643838653439643463613330653665363962633035303765626435323a303030303030303030303a616631623233303732393834663961333439346464613664663836366535323863653633343965376239313464366532353630623633313034633533323432373a313639333132373933373237383937363932390acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078386631633238666465613937636337633135626432663134303839383863303430346432663335313533343137366262336136666663633266303538643664623a303030303030303030303a656232323633656132646166393039336236323235333566636463373362303562326535316263333162303662326664366463663563663534663439353032303a313639333131343631373237363335363431370acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078376666323234396234636430656439313639313062666336633039323738363834363936346134393131643865663530353430396361373464393135633664323a303030303030303030303a633035363936356365346238636430323336626234666439643338313133396366306135383634356331323864383661636666623536613262653264373836323a313639333039353432383238383030363239300acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078323937353732396433646235353332373663353535633962373733653062633238386437383661306333623334626536643832393166323137376166623238613a303030303030303030303a396364343630393331663730393038366532323463616533323765613063633266663434633134613638643263636631343833396366626133393933646465303a313639333033333633333239313437393833360acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078323837353832336430626462386466323735633033346166363539656364303735613562393834656535313935623032383434303834376537636365646330313a303030303030303030303a366263343130336136326139373737623039396335383435396262666236376234313430356363333732336130366431343136393865626339336333373039633a313639333131353831343237373936363432330acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078323535633163663939373662376635366334376363356634383536366236636236303433623333326233393036373535376332323936633363653035303435343a303030303030303030303a366533323231623630653038303939363063613330376131646163346462663338626234663935643164613938313165383439353762663834313338323539303a313639333032323132313330393038313238330acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078323131323536376266303335336231666539323035663062623965666530376135323639396162326635373931346331663263333431626162636566633264343a303030303030303030303a386566616365663866656230366235653264666635613039363066666130633337633861313330323230386238393333326130306463383237316433356438313a313639333035383334303238363534303034310acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078323038633634633132343564633036376632646432623239653033623131636266613362303566386331303063383765643834653462633161633637376230303a303030303030303030313a623632306539326265646537356638323336653161356262663164323434306366633335623066333566373263343735343330663863363861633664643833393a313639333130313637343239353632303336360acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078323038633038366264653138373265636266653839373161393632653234653132633430613334366137653861353065613066316433303032386134653364653a303030303030303030303a616235376635623632393436303164656664373363303930393332663030353031623838313032646536346163393061616466613736633533306630643138383a313639333038323232333238343736343836380acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078316439363434303233303332623231626337643230613162666662626136356366623962303832626134353763323633636161633562393436663935383236363a303030303030303030303a306434316131653131343537616132356463626261343230653532323464653332636237376462383964613936313735303631613930346631616565653462663a313639333033383435323332303838313937390acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078306561393033396232333963646261363763646132313732616234323330353066643735386561336630613431353732376539643433343837666263316234303a303030303030303030303a653162363365373430646464316234333739363361336338373563323231306366616263343137663033303136336630366138633738643461353735386565383a313639333130373636323238323234323638340acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078303830373738363634313065363263326166323535643637383664663936323765646638626664376136346530633839633064343739656236636363353231633a303030303030303030303a363366323064303865663934363462373138646664346334386539663734346131663262396336366232623464366266323038633132303466383566666437323a313639333131373938353238343130323338370acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078303765343937653333323634326464396461313839373831303762306463356162376337323164656136643934363030653966336532326239626166316139643a303030303030303030303a653464336431336636346661623637323463346635343366626338636666313166316663353962376234316464353132626333376637313265346136656533653a313639333036343834323330313437313336350acd013078363661656561333932333164343837303135363964663862353962663565646166383139346534303a3078303363326333353963393031343638373262393735613637356433336333383932376230656138376663303538383461343464613266383930633839643066663a303030303030303030303a393162373532303030323735303763366539656164306135633332393538323361656633646338333662393161656533663066313162323464313431316437303a3136393330393230383033303837373731343220c0cf2428a799b7a70630d5b59a8bb3be83cb603a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470"

	etx := ethtypes.NewTransaction(nonce, to, big.NewInt(0), 3000000, big.NewInt(10e9), common.FromHex(bindRawTx))

	var privKey = "4e4a3e491da77c429e1ee27575b381d7974778bd96a4f1cce61f82ec76986e42"

	//0xa42431da868c58877a627cc71dc95f01bf40c196
	privKey = "7939624566468cfa3cb2c9f39d5ad83bdc7cf4356bfd1a7b8094abda6b0699d1"
	pk, err := crypto.ToECDSA(common.FromHex(privKey))
	if err != nil {
		t.Log(err)
		return
	}
	signer := ethtypes.NewEIP155Signer(big.NewInt(1999))
	signtx, err := ethtypes.SignTx(etx, signer, pk)
	if err != nil {
		t.Log(err)
		return
	}

	signedTrans, err := rlp.EncodeToBytes(signtx)
	if err != nil {
		t.Log(err)
		return
	}

	t.Log("signedTx:", common.Bytes2Hex(signedTrans))
	return

}

func TestSend2TicketExec(t *testing.T) {
	var sendExec = "0a05636f696e73123718010a3310808090bcfd02222a30786134323433314461383638633538383737613632374343373144633935463031626634306331393620a08d06309495e0fdf4beabe86e3a2a307861343234333144613836386335383837376136323743433731446339354630316266343063313936"

	var nonce uint64 = 11
	var to = common.HexToAddress("0x0000000000000000000000000000000000200005")
	etx := ethtypes.NewTransaction(nonce, to, big.NewInt(0), 9000000, big.NewInt(10e9), common.FromHex(sendExec))
	//0xa42431Da868c58877a627CC71Dc95F01bf40c196
	var privKey = "7939624566468cfa3cb2c9f39d5ad83bdc7cf4356bfd1a7b8094abda6b0699d1"
	privKey = "4e3f0db8f4c21a239cde32d63e371d2ce52cc2f936b400a2537032e59e5a208f"
	//0xd83b69c56834e85e023b1738e69bfa2f0dd52905
	privKey = "c8729f05b10cc74d40feeb00376e11aa5b50e92b369d778b31b6e902c528f141"
	pk, err := crypto.ToECDSA(common.FromHex(privKey))
	if err != nil {
		t.Log(err)
		return
	}
	signer := ethtypes.NewEIP155Signer(big.NewInt(2999))
	signtx, err := ethtypes.SignTx(etx, signer, pk)
	if err != nil {
		t.Log(err)
		return
	}

	signedTrans, err := rlp.EncodeToBytes(signtx)
	if err != nil {
		t.Log(err)
		return
	}

	t.Log("signedTx:", common.Bytes2Hex(signedTrans))
	return
}

func TestSend2Chain(t *testing.T) {
	ecli, err := ethclient.Dial("http://192.168.61.213:8545")
	if err != nil {
		panic(err)
	}

	var tx1 = "f90100288502540be400832dc6c094000000000000000000000000000000000020000580b8980a067469636b6574125c50112a580a2a307836366165656133393233316434383730313536396466386235396266356564616638313934653430122a30786134323433316461383638633538383737613632376363373164633935663031626634306331393620a08d06309cdecd89eef5b2bb123a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470820fc2a0bc2549364a611da10413de5c531290d3f9717fc5ff18dd54335dacd7fc276424a029148b59723d1abbf7d000b11a0987ea1feca282788c41567761a1985a683b15"
	//create tx2
	var etx1 = new(ethtypes.Transaction)
	err = rlp.DecodeBytes(common.FromHex(tx1), etx1)
	if err != nil {
		panic(err)
	}

	var to = common.HexToAddress("0xd83b69C56834E85e023B1738E69BFA2F0dd52905")
	etx := ethtypes.NewTransaction(39, to, big.NewInt(100000000), 9000000, big.NewInt(10e9), nil)
	privKey := "7939624566468cfa3cb2c9f39d5ad83bdc7cf4356bfd1a7b8094abda6b0699d1"
	pk, err := crypto.ToECDSA(common.FromHex(privKey))
	if err != nil {
		t.Log(err)
		return
	}
	signer := ethtypes.NewEIP155Signer(big.NewInt(1999))
	signtx, err := ethtypes.SignTx(etx, signer, pk)
	if err != nil {
		t.Log(err)
		return

	}
	/*
		var v, r, s = etx1.RawSignatureValues()
		cv, err := etypes.CaculateRealV(v, etx1.ChainId().Uint64(), etx1.Type())
		assert.Nil(t, err)

		sig := make([]byte, 65)
		copy(sig[32-len(r.Bytes()):32], r.Bytes())
		copy(sig[64-len(s.Bytes()):64], s.Bytes())
		sig[64] = cv
		pubkey, err := crypto.Ecrecover(signer.Hash(etx1).Bytes(), sig)
		chain33Tx := etypes.AssembleChain33Tx(etx1, sig, pubkey, ethCli.cfg)

		t.Log("tx:", common.Bytes2Hex(ctypes.Encode(chain33Tx)))
	*/

	err = ecli.SendTransaction(context.Background(), etx1)
	if err != nil {
		t.Log(err)
		return
	}

	t.Log("etx1.hash:", etx1.Hash().String())
	return
	err = ecli.SendTransaction(context.Background(), signtx)
	if err != nil {
		t.Log(err)
		return
	}
	t.Log("etx2.hash:", signtx.Hash().String())
}
